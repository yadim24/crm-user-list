# Список пользователей

## Запуск SPA-приложения

1. `npm i`
2. `npm run app:start`
3. `npx msw init public`

## Mock data

Для эмуляции REST API запросов используется библиотека MSW, которая работает только в режиме разработки. Данные хранятся в памяти при работе приложения.

## Авторизация

За основу авторизации взят алгоритм работы с JWT токенами:

1. Отправляется запрос на сервер с логином, паролем.
2. Сервер в ответ присылает access и refresh token'ы в json.
3. Access token сохраняется в памяти и соответственно удаляется при закрытии страницы приложения.
4. Refresh token сохраняется в session storage.
5. При открытии страницы приложения происходит запрос данных текущего пользователя `/users/me/`.
6. Но т.к. access token хранится в памяти, то запрос происходит с пустым access token, что приводит к ошибке авторизации (статус `401`).
7. Приложение пытается обновить access token через endpoint `/auth/token/jwt/refresh/`, отправляя в json refresh token.
8. В ответ сервер присылает новые access token и refresh token.
9. Запрос повторяется с валидным access token.
10. При запросе access token передается в заголовке `Authorization`.
11. Refresh token передается только при обновлении/получении access token.

## Структура проекта

### REST запросы

Запросы находятся в каталоге `api`. В каталоге `endpoints` лежат хуки, предназначенные для выполнения запросов на определенные эндпоинты. В каталоге `types` описаны типы объектов DTO и схемы валидации.

### Каталог `App`

В каталоге `App` находятся провайдеры, подключение темы, toaster, глобальный обработчик ошибок.

### Каталог `AppRoutes`

В каталоге `AppRoutes` находится маршрутизация приложения.

### Каталог `store`

Настройка Redux хранилища.

### Каталог `shared`

Все общеиспользуемые компоненты, хуки, функции и т.д. Каталог `shared` может быть глобальным или/и локальным. Если внутри модуля/страницы есть подмодули, которые используют общие компоненты, функции, константы и т.д., и они не используются в других модулях верхнего уровня, тогда каталог `shared` может быть создан на уровне этого модуля.

### Остальные каталоги

Каждый отдельный каталог - отдельная страница (рассматривается как отдельный модуль).

### Подкаталоги

Если компнента содержит внутри себя другие компоненты, то внутри каталога создается подкаталог. Внутрение компоннеты не должны импортировать компоннеты верхнего уровня, только если они не расположены в каталоге `shared`.

## Обработка ошибок

### Список обрабатываемых статусов явным образом

Явно отслеживаются ошибки содержащие следующий статус код:

`401` - полученный на `/auth/refresh_token` означает проблемы обновления access token используя refresh token; означает ошибку аутентификации, просрочен access token и т.п. В интерсептере axios эта ошибка перехватывается и происходит попытка обновить access token, если в течении 30 секунд и исчерпании 5 повторений так и не удалось обновить access token, то ошибка будет обработана приложением с соответствующим сообщением.

`403` - используется для получения ошибок авторизации или ограничения прав доступа.

`404` - данные не найдены.

`422` - используется только для получения ошибок для полей форм и т.п.

### Остальные ошибки обрабатываются по следующему принципу

За основу взят формат ошибки Fast API по умолчанию.

1. Объект ошибки содержит поле detail строку или массив.

2. Если общая ошибка, поле detail строка и ошибка будет выведена в тостер.

3. Если ошибка формы, то поле detail массив и ошибка она будет выведена под конкретным полем формы.

2. Если ошибка не имеет тела или оно другой структуры, то пользователь получит сообщение - `Обнаружены неизвестные ошибки.`

3. Если сервер не отвечает в течении 1 минуты, то в axios сработает timeout, ошибка будет обработана - `Превышено время ожидания ответа сервера.`

4. Если сервер отдаст во время обновления невалидный access token, то при попытке запроса таким токеном сработает превывание запроса - `Запрос был прерван. Возможно это связано с проблемами авторизации.`